#+TITLE: Reomacs
#+PROPERTY: header-args:emacs-lisp :tangle config.el :lexical t :noweb yes :results silent

* Prep

** Lexical bindings, duh...

#+begin_src emacs-lisp
  ;;; -*- lexical-binding: t -*-
#+end_src

** Macros

#+begin_src emacs-lisp
  (defmacro comment (&rest _body)
    "Ignores all arguments and returns nil.
Use to comment out blocks of code without disabling them with semicolons."
    nil)
#+end_src

** Auto-Tangle

#+begin_src emacs-lisp
  (defun reomacs/tangle-config-org ()
    "Tangle config.org automatically if in `user-emacs-directory`"
    (when (string-equal (buffer-file-name)
                        (expand-file-name "config.org" user-emacs-directory))
      (let ((org-confirm-babel-evaluate nil))
        (org-babel-tangle))))

  (add-hook 'after-save-hook #'reomacs/tangle-config-org)
  (comment
    (reomacs/tangle-config-org))
#+end_src

** Defaults

#+begin_src emacs-lisp
  (defun reomacs/setup-frame-ui (frame)
    (with-selected-frame frame
      (when (display-graphic-p frame)
        (tool-bar-mode -1)
        (menu-bar-mode -1)
        (scroll-bar-mode -1))))

  ;; Run immediately for the first frame
  (reomacs/setup-frame-ui (selected-frame))

  ;; Run for any new frames created (e.g. from emacsclient -c)
  (add-hook 'after-make-frame-functions #'reomacs/setup-frame-ui)

  (setopt scroll-step 1)
  (setopt scroll-margin 1)

  (setopt x-select-enable-clipboard t)
  (fset 'yes-or-no-p 'y-or-n-p)
  (pixel-scroll-precision-mode)
  ;; (pixel-scroll-precision-use-momentum)

  ;; Fonts
  (when (member "FiraCode Nerd Font" (font-family-list))
    (set-face-attribute 'default nil :font "FiraCode Nerd Font" :height 108)
    (set-face-attribute 'fixed-pitch nil :font "FiraCode Nerd Font"))

  ;; Indentation
  ;; Always use spaces instead of tabs
  (setq-default indent-tabs-mode nil)

  ;; Specifically make sure org-mode and emacs-lisp-mode use spaces
  (add-hook 'org-mode-hook (lambda () (setq indent-tabs-mode nil)))
  (add-hook 'emacs-lisp-mode-hook (lambda () (setq indent-tabs-mode nil)))

  ;; Optional: make tab always insert 2 spaces (or your preferred width)
  (setq-default tab-width 2)
#+end_src

** Package Manager (straight)

#+begin_src emacs-lisp
  (defvar bootstrap-version)
  (let ((bootstrap-file
         (expand-file-name
          "straight/repos/straight.el/bootstrap.el"
          (or (bound-and-true-p straight-base-dir)
              user-emacs-directory)))
        (bootstrap-version 7))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
          (url-retrieve-synchronously
           "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
           'silent 'inhibit-cookies)
        (goto-char (point-max))
        (eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))
  (setopt straight-use-package-by-default t)
#+end_src

* UI

** Theme

#+begin_src emacs-lisp
  (load-theme 'modus-vivendi-tinted t)
#+end_src

** Scratch

#+begin_src emacs-lisp
  (with-current-buffer (get-buffer-create "*scratch*")
    (let* ((banner "
            ;;
            ;; ██████╗  ███████╗ ██████╗ ███╗   ███╗ █████╗  ██████╗███████╗
            ;; ██╔══██╗ ██╔════╝██╔═══██╗████╗ ████║██╔══██╗██╔════╝██╔════╝
            ;; ██████╔╝ █████╗  ██║   ██║██╔████╔██║███████║██║     ███████╗
            ;; ██╔══██╗ ██╔══╝  ██║   ██║██║╚██╔╝██║██╔══██║██║     ╚════██║
            ;; ██║   ██║███████╗╚██████╔╝██║ ╚═╝ ██║██║  ██║╚██████╗███████║
            ;; ╚═╝   ╚═╝╚══════╝ ╚═════╝ ╚═╝     ╚═╝╚═╝  ╚═╝ ╚═════╝╚══════╝
            ;;
            ;;   Loading time : %s
            ;;   Packages     : %s
            ")
           (cleaned-banner (string-trim
                            (replace-regexp-in-string
                             "^\\s-*;;" ";;"
                             banner))))
    (insert (format cleaned-banner
             (emacs-init-time)
             (number-to-string (length package-activated-list))))))

  (message (emacs-init-time))
#+end_src

** Nova

#+begin_src emacs-lisp
  (use-package nova
    :straight (:host github :repo "thisisran/nova")
    :config
    (nova-vertico-mode 1)
    (nova-eldoc-mode 1))
#+end_src


** Scrolling

#+begin_src emacs-lisp
  (use-package ultra-scroll
    :straight (:host github :repo "jdtsmith/ultra-scroll")
    :init
    (setq scroll-conservatively 101 ; important!
          scroll-margin 0)
    :config
    (ultra-scroll-mode 1))
#+end_src

* Libs

- https://github.com/magnars/dash.el

#+begin_src emacs-lisp
  (use-package dash
    :config
    (global-dash-fontify-mode)
    (with-eval-after-load 'info-look
      (dash-register-info-lookup)))
#+end_src

* Modal Editing

** Meow

#+begin_src emacs-lisp :tangle nil
  (defun meow-setup ()
    (meow-motion-overwrite-define-key
     '("j" . meow-next)
     '("k" . meow-prev)
     '("<escape>" . ignore))
    (meow-leader-define-key
     ;; SPC j/k will run the original command in MOTION state.
     '("j" . "H-j")
     '("k" . "H-k")
     ;; Use SPC (0-9) for digit arguments.
     '("1" . meow-digit-argument)
     '("2" . meow-digit-argument)
     '("3" . meow-digit-argument)
     '("4" . meow-digit-argument)
     '("5" . meow-digit-argument)
     '("6" . meow-digit-argument)
     '("7" . meow-digit-argument)
     '("8" . meow-digit-argument)
     '("9" . meow-digit-argument)
     '("0" . meow-digit-argument)
     '("/" . meow-keypad-describe-key)
     '("?" . meow-cheatsheet))
    (meow-normal-define-key
     '("0" . meow-expand-0)
     '("9" . meow-expand-9)
     '("8" . meow-expand-8)
     '("7" . meow-expand-7)
     '("6" . meow-expand-6)
     '("5" . meow-expand-5)
     '("4" . meow-expand-4)
     '("3" . meow-expand-3)
     '("2" . meow-expand-2)
     '("1" . meow-expand-1)
     '("-" . negative-argument)
     '(";" . meow-reverse)
     '("," . meow-inner-of-thing)
     '("." . meow-bounds-of-thing)
     '("[" . meow-beginning-of-thing)
     '("]" . meow-end-of-thing)
     '("a" . meow-append)
     '("A" . meow-open-below)
     '("b" . meow-back-word)
     '("B" . meow-back-symbol)
     '("c" . meow-change)
     '("d" . meow-delete)
     '("D" . meow-backward-delete)
     '("e" . meow-next-word)
     '("E" . meow-next-symbol)
     '("f" . meow-find)
     '("g" . meow-cancel-selection)
     '("G" . meow-grab)
     '("h" . meow-left)
     '("H" . meow-left-expand)
     '("i" . meow-insert)
     '("I" . meow-open-above)
     '("j" . meow-next)
     '("J" . meow-next-expand)
     '("k" . meow-prev)
     '("K" . meow-prev-expand)
     '("l" . meow-right)
     '("L" . meow-right-expand)
     '("m" . meow-join)
     '("n" . meow-search)
     '("o" . meow-block)
     '("O" . meow-to-block)
     '("p" . meow-yank)
     '("q" . meow-quit)
     '("Q" . meow-goto-line)
     '("r" . meow-replace)
     '("R" . meow-swap-grab)
     '("s" . meow-kill)
     '("t" . meow-till)
     '("u" . meow-undo)
     '("U" . meow-undo-in-selection)
     '("v" . meow-visit)
     '("w" . meow-mark-word)
     '("W" . meow-mark-symbol)
     '("x" . meow-line)
     '("X" . meow-goto-line)
     '("y" . meow-save)
     '("Y" . meow-sync-grab)
     '("z" . meow-pop-selection)
     '("'" . repeat)
     '("<escape>" . ignore))
    ;; My own config
    (meow-leader-define-key
     '("y" . "C-y")))
    ;; (meow-normal-define-key
    ;;  '("(" . insert-pair)))

  (use-package meow
    :straight (:host github :repo "meow-edit/meow" :branch "v1.5.0")
    :custom (meow-cheatsheet-layout meow-cheatsheet-layout-qwerty)
    :config
    (meow-setup)
    (meow-global-mode 1))
  
  ;;  Meow Tree Sitter
  (use-package meow-tree-sitter
    :straight (meow-tree-sitter
               :host github :repo "skissue/meow-tree-sitter"
               :files
               (:defaults "queries"))
    :config
    (meow-tree-sitter-register-defaults))
  ;; (add-to-list 'meow-tree-sitter-major-mode-language-alist '("dart" . "dart")))  
#+end_src

** Evil

#+begin_src emacs-lisp
  (use-package evil
    :straight (:host github :repo "emacs-evil/evil")
    :init
    ;; (setopt evil-want-integration t)
    (setopt evil-want-keybinding nil)
    (setopt evil-want-C-u-scroll t)
    (setopt evil-want-C-d-scroll t)
    (setopt evil-want-C-o-jump t)
    (setopt evil-want-C-i-jump t)
    (setopt evil-vsplit-window-right t)
    (setopt evil-split-window-below t)
    (setopt evil-undo-system 'undo-redo)
    ;; (setopt evil-cross-lines t) ;; Shadowed by evil-snipe
    :config
    (evil-mode 1)
    (define-key evil-insert-state-map (kbd "C-g") 'evil-normal-state)

    (evil-set-initial-state 'messages-buffer-mode 'normal)
    (evil-set-initial-state 'dashboard-mode 'normal))

  (use-package evil-collection
    :after evil
    :config
    ;; (setopt evil-collection-mode-list '(dashboard dired ibuffer))
    (evil-collection-init))

  (use-package evil-tutor)

  (use-package evil-goggles
    :config
    (evil-goggles-mode)

    ;; optionally use diff-mode's faces; as a result, deleted text
    ;; will be highlighed with `diff-removed` face which is typically
    ;; some red color (as defined by the color theme)
    ;; other faces such as `diff-added` will be used for other actions
    (evil-goggles-use-diff-faces)
    (setopt evil-goggles-duration 0.100))
#+end_src

* TreeSitter

#+begin_src emacs-lisp
  ;; (use-package tree-sitter
  ;;   :config
  ;;   (global-tree-sitter-mode))
  ;; (use-package parinfer-rust-mode
  ;;   :straight nil
  ;;   :hook ((clojure-mode emacs-lisp-mode) . parinfer-rust-mode))

  (use-package treesit
    :straight nil)
  ;; :config
  ;; (global-tree-sitter-mode))
#+end_src

* Lisp

#+begin_src emacs-lisp
  ;;(use-package parinfer-rust-mode
  ;;  :init
  ;;  (setopt parinfer-rust-auto-download nil)
  ;;  :hook emacs-lisp-mode)
#+end_src

* Completion

#+begin_src emacs-lisp
  ;; Enable Vertico.
  (use-package vertico
    :custom
    ;; (vertico-scroll-margin 0) ;; Different scroll margin
    (vertico-count 20) ;; Show more candidates
    ;; (vertico-resize t) ;; Grow and shrink the Vertico minibuffer
    (vertico-cycle t) ;; Enable cycling for `vertico-next/previous'
    :init
    (vertico-mode))

  ;; Persist history over Emacs restarts. Vertico sorts by history position.
  (use-package savehist
    :init
    (savehist-mode))

  ;; Emacs minibuffer configurations.
  (use-package emacs
    :custom
    ;; Support opening new minibuffers from inside existing minibuffers.
    (enable-recursive-minibuffers t)
    ;; Hide commands in M-x which do not work in the current mode.  Vertico
    ;; commands are hidden in normal buffers. This setting is useful beyond
    ;; Vertico.
    (read-extended-command-predicate #'command-completion-default-include-p)
    ;; Do not allow the cursor in the minibuffer prompt
    (minibuffer-prompt-properties
     '(read-only t cursor-intangible t face minibuffer-prompt)))

  ;; Optionally use the `orderless' completion style.
  (use-package orderless
    :custom
    ;; Configure a custom style dispatcher (see the Consult wiki)
    ;; (orderless-style-dispatchers '(+orderless-consult-dispatch orderless-affix-dispatch))
    ;; (orderless-component-separator #'orderless-escapable-split-on-space)
    (completion-styles '(orderless basic))
    (completion-category-defaults nil)
    (completion-category-overrides '((file (styles partial-completion)))))

  ;; Example configuration for Consult
  (use-package consult
    ;; Replace bindings. Lazily loaded by `use-package'.
    :bind (;; C-c bindings in `mode-specific-map'
           ("C-c M-x" . consult-mode-command)
           ("C-c h" . consult-history)
           ("C-c k" . consult-kmacro)
           ("C-c m" . consult-man)
           ("C-c i" . consult-info)
           ([remap Info-search] . consult-info)
           ;; C-x bindings in `ctl-x-map'
           ("C-x M-:" . consult-complex-command)     ;; orig. repeat-complex-command
           ("C-x b" . consult-buffer)                ;; orig. switch-to-buffer
           ("C-x 4 b" . consult-buffer-other-window) ;; orig. switch-to-buffer-other-window
           ("C-x 5 b" . consult-buffer-other-frame)  ;; orig. switch-to-buffer-other-frame
           ("C-x t b" . consult-buffer-other-tab)    ;; orig. switch-to-buffer-other-tab
           ("C-x r b" . consult-bookmark)            ;; orig. bookmark-jump
           ("C-x p b" . consult-project-buffer)      ;; orig. project-switch-to-buffer
           ;; Custom M-# bindings for fast register access
           ("M-#" . consult-register-load)
           ("M-'" . consult-register-store)          ;; orig. abbrev-prefix-mark (unrelated)
           ("C-M-#" . consult-register)
           ;; Other custom bindings
           ("M-y" . consult-yank-pop)                ;; orig. yank-pop
           ;; M-g bindings in `goto-map'
           ("M-g e" . consult-compile-error)
           ("M-g f" . consult-flymake)               ;; Alternative: consult-flycheck
           ("M-g g" . consult-goto-line)             ;; orig. goto-line
           ("M-g M-g" . consult-goto-line)           ;; orig. goto-line
           ("M-g o" . consult-outline)               ;; Alternative: consult-org-heading
           ("M-g m" . consult-mark)
           ("M-g k" . consult-global-mark)
           ("M-g i" . consult-imenu)
           ("M-g I" . consult-imenu-multi)
           ;; M-s bindings in `search-map'
           ("M-s d" . consult-find)                  ;; Alternative: consult-fd
           ("M-s c" . consult-locate)
           ("M-s g" . consult-grep)
           ("M-s G" . consult-git-grep)
           ("M-s r" . consult-ripgrep)
           ("M-s l" . consult-line)
           ("M-s L" . consult-line-multi)
           ("M-s k" . consult-keep-lines)
           ("M-s u" . consult-focus-lines)
           ;; Isearch integration
           ("M-s e" . consult-isearch-history)
           :map isearch-mode-map
           ("M-e" . consult-isearch-history)         ;; orig. isearch-edit-string
           ("M-s e" . consult-isearch-history)       ;; orig. isearch-edit-string
           ("M-s l" . consult-line)                  ;; needed by consult-line to detect isearch
           ("M-s L" . consult-line-multi)            ;; needed by consult-line to detect isearch
           ;; Minibuffer history
           :map minibuffer-local-map
           ("M-s" . consult-history)                 ;; orig. next-matching-history-element
           ("M-r" . consult-history))                ;; orig. previous-matching-history-element

    ;; Enable automatic preview at point in the *Completions* buffer. This is
    ;; relevant when you use the default completion UI.
    :hook (completion-list-mode . consult-preview-at-point-mode)

    ;; The :init configuration is always executed (Not lazy)
    :init

    ;; Tweak the register preview for `consult-register-load',
    ;; `consult-register-store' and the built-in commands.  This improves the
    ;; register formatting, adds thin separator lines, register sorting and hides
    ;; the window mode line.
    (advice-add #'register-preview :override #'consult-register-window)
    (setopt register-preview-delay 0.5)

    ;; Use Consult to select xref locations with preview
    (setopt xref-show-xrefs-function #'consult-xref
            xref-show-definitions-function #'consult-xref)

    ;; Configure other variables and modes in the :config section,
    ;; after lazily loading the package.
    :config

    ;; Optionally configure preview. The default value
    ;; is 'any, such that any key triggers the preview.
    ;; (setopt consult-preview-key 'any)
    ;; (setopt consult-preview-key "M-.")
    ;; (setopt consult-preview-key '("S-<down>" "S-<up>"))
    ;; For some commands and buffer sources it is useful to configure the
    ;; :preview-key on a per-command basis using the `consult-customize' macro.
    (consult-customize
     consult-theme :preview-key '(:debounce 0.2 any)
     consult-ripgrep consult-git-grep consult-grep consult-man
     consult-bookmark consult-recent-file consult-xref
     consult--source-bookmark consult--source-file-register
     consult--source-recent-file consult--source-project-recent-file
     ;; :preview-key "M-."
     :preview-key '(:debounce 0.4 any))

    ;; Optionally configure the narrowing key.
    ;; Both `&lt;` and C-+ work reasonably well.
    (setopt consult-narrow-key "<") ;; "C-+"

    ;; Optionally make narrowing help available in the minibuffer.
    ;; You may want to use `embark-prefix-help-command' or which-key instead.
    ;; (keymap-set consult-narrow-map (concat consult-narrow-key " ?") #'consult-narrow-help)

    (setopt consult-project-function #'consult--default-project--function))

  ;; Enable rich annotations using the Marginalia package
  (use-package marginalia
    ;; Bind `marginalia-cycle' locally in the minibuffer.  To make the binding
    ;; available in the *Completions* buffer, add it to the
    ;; `completion-list-mode-map'.
    :bind (:map minibuffer-local-map
                ("M-A" . marginalia-cycle))

    ;; The :init section is always executed.
    :init

    ;; Marginalia must be activated in the :init section of use-package such that
    ;; the mode gets enabled right away. Note that this forces loading the
    ;; package.
    (marginalia-mode))

  (use-package embark
    :straight t

    :bind
    (("C-." . embark-act)         ;; pick some comfortable binding
     ("C-;" . embark-dwim)        ;; good alternative: M-.
     ("C-h B" . embark-bindings)) ;; alternative for `describe-bindings'

    :init

    ;; Optionally replace the key help with a completing-read interface
    (setopt prefix-help-command #'embark-prefix-help-command)

    ;; Show the Embark target at point via Eldoc. You may adjust the
    ;; Eldoc strategy, if you want to see the documentation from
    ;; multiple providers. Beware that using this can be a little
    ;; jarring since the message shown in the minibuffer can be more
    ;; than one line, causing the modeline to move up and down:

    ;; (add-hook 'eldoc-documentation-functions #'embark-eldoc-first-target)
    ;; (setopt eldoc-documentation-strategy #'eldoc-documentation-compose-eagerly)

    :config

    ;; Hide the mode line of the Embark live/completions buffers
    (add-to-list 'display-buffer-alist
                 '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                   nil
                   (window-parameters (mode-line-format . none)))))

  ;; Consult users will also want the embark-consult package.
  (use-package embark-consult
    :straight t ; only need to install it, embark loads it after consult if found
    :hook
    (embark-collect-mode . consult-preview-at-point-mode))
#+end_src

* Projects

#+begin_src emacs-lisp
  (use-package project
    :straight nil
    :custom
    (project-switch-commands
     '((magit-project-status "Magit")
       (project-find-file "Find file")
       (project-find-dir "Find directory")
       (project-eshell "Eshell")
       (project-vc-dir "VC")))
    :bind
    ("C-c p f" . project-find-file)
    ("C-c p p" . project-switch-project)
    ("C-c p d" . project-find-dir))
#+end_src

* Documentts
** Org

#+begin_src emacs-lisp
  (use-package org
    :defer
    :straight `(org
                :fork (:host nil
                       :repo "https://git.tecosaur.net/tec/org-mode.git"
                       :branch "dev"
                       :remote "tecosaur")
                :files (:defaults "etc")
                :build t
                :pre-build
                (with-temp-file "org-version.el"
                 (require 'lisp-mnt)
                 (let ((version
                        (with-temp-buffer
                          (insert-file-contents "lisp/org.el")
                          (lm-header "version")))
                       (git-version
                        (string-trim
                         (with-temp-buffer
                           (call-process "git" nil t nil "rev-parse" "--short" "HEAD")
                           (buffer-string)))))
                  (insert
                   (format "(defun org-release () \"The release version of Org.\" %S)\n" version)
                   (format "(defun org-git-version () \"The truncate git commit hash of Org mode.\" %S)\n" git-version)
                   "(provide 'org-version)\n")))
                :pin nil))

  (use-package org-superstar
    :config
    (add-hook 'org-mode-hook (lambda () (org-superstar-mode 1))))

  (dolist (face '((org-level-1 . 1.35)
                  (org-level-2 . 1.3)
                  (org-level-3 . 1.2)
                  (org-level-4 . 1.1)
                  (org-level-5 . 1.1)
                  (org-level-6 . 1.1)
                  (org-level-7 . 1.1)
                  (org-level-8 . 1.1)))
    (set-face-attribute (car face) nil
                        :font "FiraCode Nerd Font"
                        :weight 'bold
                        :height (cdr face)))
  (set-face-attribute 'org-document-title nil
                      :font "FiraCode Nerd Font"
                      :weight 'bold
                      :height 1.8)

  (setq-default prettify-symbols-alist
                  '(("#+BEGIN_SRC" . "†")
                    ("#+END_SRC" . "†")
                    ("#+begin_src" . "†")
                    ("#+end_src" . "†")
                    (">=" . "≥")
                    ("=>" . "⇨")))

  (setq prettify-symbols-unprettify-at-point 'right-edge)
  (add-hook 'org-mode-hook 'prettify-symbols-mode)

  (add-to-list 'org-structure-template-alist
               '("el" . "src emacs-lisp"))

  (defun reo101/org-l2-to-markdown-clipboard (&optional level-offset)
    "Get the contents of the surrounding level 2 heading (** Heading),
  convert to markdown, copy to clipboard, and clean up all buffers and windows.
  Optional LEVEL-OFFSET (default 0) offsets heading levels in the output.
  For example, with LEVEL-OFFSET=1, level 3 headings become level 2 (##) in markdown."
    (interactive "P")
    ;; Process the prefix argument
    (when (and level-offset (not (numberp level-offset)))
      (setq level-offset (prefix-numeric-value level-offset)))
    (setq level-offset (or level-offset 0))
    
    (save-window-excursion
      (let ((temp-buf (generate-new-buffer "*org-to-md-temp*"))
            content-start end heading)
        (unwind-protect
            (progn
              ;; Find the level 2 heading
              (unless (org-at-heading-p)
                (org-back-to-heading t))
              
              ;; If we're not on a level 2 heading, search for one
              (when (not (= (org-current-level) 2))
                (while (and (not (= (org-current-level) 2))
                           (org-up-heading-safe))))
              
              ;; If we didn't find a level 2 heading, error out
              (unless (= (org-current-level) 2)
                (error "No level 2 heading found"))
              
              ;; Get the heading text for feedback
              (setq heading (org-get-heading t t t t))
              
              ;; Move past the heading to get only the content
              (forward-line 1)
              (setq content-start (point))
              
              ;; Get the end of the heading content
              (org-end-of-subtree t t)
              (setq end (point))
              
              ;; Extract just the content (not the heading itself)
              (let ((content (buffer-substring-no-properties content-start end)))
                (with-current-buffer temp-buf
                  (org-mode)
                  (insert content)
                  
                  ;; Configure export options to avoid problematic elements
                  (let ((org-export-with-toc nil)           ;; No table of contents
                        (org-export-with-timestamps nil)    ;; No timestamps
                        (org-export-with-section-numbers nil) ;; No section numbers
                        (org-export-with-broken-links t)    ;; Don't fail on broken links
                        (org-export-with-smart-quotes nil)  ;; No smart quotes
                        (org-md-headline-style 'atx)        ;; Use # style headings
                        ;; Function to transform heading level
                        (org-export-filter-headline-functions
                         (list 
                          (lambda (text backend info)
                            (when (eq backend 'md)
                              ;; Apply level offset by adjusting number of # marks
                              (if (> level-offset 0)
                                  (replace-regexp-in-string
                                   (rx string-start (group (one-or-more "#")))
                                   (lambda (match)
                                     (let* ((hashes (match-string 1 match))
                                            (level (length hashes))
                                            ;; Apply offset and ensure we have at least one #
                                            (new-level (max 1 (- level level-offset))))
                                       (make-string new-level ?#)))
                                   text)
                                text))))))
                    
                    ;; Export to markdown string
                    (let ((md-content (org-export-string-as (buffer-string) 'md t)))
                      ;; Remove the anchor tags that might still be present
                      (setq md-content (replace-regexp-in-string "<a id=\"[^\"]+\"></a>" "" md-content))
                      
                      ;; Copy to clipboard
                      (kill-new md-content)
                      (message "Content from heading \"%s\" converted to markdown and copied to clipboard (level offset: %d)" 
                               heading level-offset)))
                  ))
              )
          ;; Cleanup in all cases
          (when (buffer-live-p temp-buf)
            (kill-buffer temp-buf))
          (when (get-buffer "*Org MD Export*")
            (kill-buffer "*Org MD Export*"))))))
#+end_src

** Tex

#+begin_src emacs-lisp
  ;; (use-package tex
  ;;   :straight auctex)
  (use-package tex
    :straight auctex
    :defer t)
#+end_src

* Dired

- From https://www.rahuljuliato.com/posts/dired-enhanced

#+begin_src emacs-lisp
  ;;; EMACS-SOLO-DIRED-ICONS
  ;;
  ;; (use-package emacs-solo-dired-icons
  ;;   :straight nil
  ;;   :no-require t
  ;;   :defer t
  ;;   :init
  ;;   (defvar emacs-solo/dired-icons-file-icons
  ;;     '(("el" . "📜")      ("rb" . "💎")      ("js" . "⚙️")      ("ts" . "⚙️")
  ;;        ("json" . "🗂️")    ("md" . "📝")      ("txt" . "📝")     ("html" . "🌐")
  ;;        ("css" . "🎨")     ("scss" . "🎨")    ("png" . "🖼️")    ("jpg" . "🖼️")
  ;;        ("jpeg" . "🖼️")   ("gif" . "🖼️")    ("svg" . "🖼️")    ("pdf" . "📄")
  ;;        ("zip" . "📦")     ("tar" . "📦")     ("gz" . "📦")      ("bz2" . "📦")
  ;;        ("7z" . "📦")      ("org" . "📝")    ("sh" . "💻")      ("c" . "🔧")
  ;;        ("h" . "📘")       ("cpp" . "➕")     ("hpp" . "📘")     ("py" . "🐍")
  ;;        ("java" . "☕")    ("go" . "🌍")      ("rs" . "💨")      ("php" . "🐘")
  ;;        ("pl" . "🐍")      ("lua" . "🎮")     ("ps1" . "🔧")     ("exe" . "⚡")
  ;;        ("dll" . "🔌")     ("bat" . "⚡")      ("yaml" . "⚙️")    ("toml" . "⚙️")
  ;;        ("ini" . "⚙️")     ("csv" . "📊")     ("xls" . "📊")     ("xlsx" . "📊")
  ;;        ("sql" . "🗄️")    ("log" . "📝")     ("apk" . "📱")     ("dmg" . "💻")
  ;;        ("iso" . "💿")     ("torrent" . "⏳") ("bak" . "🗃️")    ("tmp" . "⚠️")
  ;;        ("desktop" . "🖥️") ("md5" . "🔐")     ("sha256" . "🔐")  ("pem" . "🔐")
  ;;        ("sqlite" . "🗄️")  ("db" . "🗄️")
  ;;        ("mp3" . "🎶")     ("wav" . "🎶")     ("flac" . "🎶")
  ;;        ("ogg" . "🎶")     ("m4a" . "🎶")     ("mp4" . "🎬")     ("avi" . "🎬")
  ;;        ("mov" . "🎬")     ("mkv" . "🎬")     ("webm" . "🎬")    ("flv" . "🎬")
  ;;        ("ico" . "🖼️")     ("ttf" . "🔠")     ("otf" . "🔠")     ("eot" . "🔠")
  ;;        ("woff" . "🔠")    ("woff2" . "🔠")   ("epub" . "📚")    ("mobi" . "📚")
  ;;        ("azw3" . "📚")    ("fb2" . "📚")     ("chm" . "📚")     ("tex" . "📚")
  ;;        ("bib" . "📚")     ("apk" . "📱")     ("rar" . "📦")     ("xz" . "📦")
  ;;        ("zst" . "📦")     ("tar.xz" . "📦")  ("tar.zst" . "📦") ("tar.gz" . "📦")
  ;;        ("tgz" . "📦")     ("bz2" . "📦")     ("mpg" . "🎬")     ("webp" . "🖼️")
  ;;        ("flv" . "🎬")     ("3gp" . "🎬")     ("ogv" . "🎬")     ("srt" . "🔠")
  ;;        ("vtt" . "🔠")     ("cue" . "📀"))
  ;;     "Icons for specific file extensions in Dired.")

  ;;   (defun emacs-solo/dired-icons-icon-for-file (file)
  ;;     (if (file-directory-p file)
  ;;          "📁"
  ;;       (let* ((ext (file-name-extension file))
  ;;               (icon (and ext (assoc-default (downcase ext) emacs-solo/dired-icons-file-icons))))
  ;;          (or icon "📄"))))

  ;;   (defun emacs-solo/dired-icons-icons-regexp ()
  ;;     "Return a regexp that matches any icon we use."
  ;;     (let ((icons (mapcar #'cdr emacs-solo/dired-icons-file-icons)))
  ;;       (concat "^\\(" (regexp-opt (cons "📁" icons)) "\\) ")))

  ;;   (defun emacs-solo/dired-icons-add-icons ()
  ;;     "Add icons to filenames in Dired buffer."
  ;;     (when (derived-mode-p 'dired-mode)
  ;;       (let ((inhibit-read-only t)
  ;;              (icon-regex (emacs-solo/dired-icons-icons-regexp)))
  ;;          (save-excursion
  ;;            (goto-char (point-min))
  ;;            (while (not (eobp))
  ;;              (condition-case nil
  ;;                    (when-let ((file (dired-get-filename nil t)))
  ;;                      (dired-move-to-filename)
  ;;                      (unless (looking-at-p icon-regex)
  ;;                        (insert (concat (emacs-solo/dired-icons-icon-for-file file) " "))))
  ;;                (error nil))  ;; gracefully skip invalid lines
  ;;              (forward-line 1))))))

  ;;   (add-hook 'dired-after-readin-hook #'emacs-solo/dired-icons-add-icons))

  (use-package wdired
    :ensure nil
    :config
    (setopt wdired-allow-to-change-permissions t
            wdired-allow-to-redirect-links t)

    ;; Rebind "r" to enter wdired in evilified dired
    (with-eval-after-load 'dired
      (evil-define-key 'normal dired-mode-map
        "r" 'wdired-change-to-wdired-mode)))

  (use-package nerd-icons-dired
    :straight t
    :hook
    (dired-mode . nerd-icons-dired-mode))
#+end_src

* Calc

#+begin_src emacs-lisp
  (use-package calc
    :defer t)

  ;; (use-package casual-calc
  ;;   :bind (:map calc-mode-map ("C-x o" . casual-calc-tmenu)
  ;;          :map calc-alg-map ("C-x o" . casual-calc-tmenu))
  ;;   :after (calc))
#+end_src

* Proof General

#+begin_src emacs-lisp
  (use-package proof-general)
#+end_src

Adapted from https://github.com/jamescherti/minimal-emacs.d/

* Core Settings

** Basic UI Improvements
Quick UI optimizations for better performance and less clutter.

#+begin_src emacs-lisp
  ;; Remove unnecessary UI elements 
  (setq ring-bell-function #'ignore)       ; No beeping or blinking
  (setq visible-bell nil)                  ; Disable visual bell
  (blink-cursor-mode -1)                   ; Disable cursor blinking
  (setq blink-matching-paren nil)          ; Don't blink matching parens

  ;; Position underlines at the descent line instead of the baseline
  (setq x-underline-at-descent-line t)

  ;; Use "…" instead of "..." for truncated text
  (setq truncate-string-ellipsis "…")
#+end_src

** Performance Optimizations
Performance tweaks to make Emacs more responsive.

#+begin_src emacs-lisp
  ;; UI update optimizations
  (setq idle-update-delay 1.0)             ; Less frequent UI updates
  (setq fast-but-imprecise-scrolling t)    ; Faster scrolling
  (setq redisplay-skip-fontification-on-input t)
  
  ;; Disable cursor in non-focused windows
  (setq-default cursor-in-non-selected-windows nil)
  (setq highlight-nonselected-windows nil)
  
  ;; GC optimizations
  (setq gc-cons-threshold 16777216)        ; 16mb
  (setq gc-cons-percentage 0.1)
#+end_src

** Minibuffer Improvements

#+begin_src emacs-lisp
  ;; Allow nested minibuffers
  (setq enable-recursive-minibuffers t)
  
  ;; Keep the cursor out of read-only portions of the minibuffer
  (setq minibuffer-prompt-properties
        '(read-only t intangible t cursor-intangible t face minibuffer-prompt))
  (add-hook 'minibuffer-setup-hook #'cursor-intangible-mode)
  
  ;; Allow shorter responses: "y" for yes and "n" for no
  (setq read-answer-short t)
  (if (boundp 'use-short-answers)
      (setq use-short-answers t)
    (advice-add 'yes-or-no-p :override #'y-or-n-p))
#+end_src

* File Handling

** File Saving and Backup

#+begin_src emacs-lisp
  ;; Backup configuration
  (use-package files
    :straight nil
    :custom
    (create-lockfiles nil)                 ; No lockfiles
    (make-backup-files t)                  ; Enable backups
    (backup-by-copying t)                  ; Copy files for backup instead of renaming
    (backup-by-copying-when-linked t)      ; Copy linked files
    (version-control t)                    ; Use version numbers for backups
    (delete-old-versions t)                ; Auto-delete old backups
    (kept-new-versions 5)                  ; Keep 5 newest versions
    (kept-old-versions 5)                  ; Keep 5 oldest versions
    :config
    (setq backup-directory-alist
          `(("." . ,(expand-file-name "backup" user-emacs-directory))))
    (setq tramp-backup-directory-alist backup-directory-alist))
#+end_src

** Auto Save

#+begin_src emacs-lisp
  (use-package files
    :straight nil
    :custom
    (auto-save-default t)                  ; Enable auto-save
    (auto-save-no-message t)               ; Silence auto-save messages
    (auto-save-include-big-deletions t)    ; Don't disable auto-save after large deletions
    (kill-buffer-delete-auto-save-files t) ; Delete auto-save files when buffer is killed
    :config
    (setq auto-save-list-file-prefix
          (expand-file-name "autosave/" user-emacs-directory))
    (setq tramp-auto-save-directory
          (expand-file-name "tramp-autosave/" user-emacs-directory)))
#+end_src

** Auto Revert
Auto-update buffers when files change on disk.

#+begin_src emacs-lisp
  (use-package autorevert
    :straight nil
    :hook (after-init . global-auto-revert-mode)
    :custom
    (revert-without-query '("."))           ; Don't prompt for revert
    (auto-revert-stop-on-user-input nil)    ; Don't interrupt auto-revert
    (auto-revert-verbose t)                 ; Show auto-revert messages
    (global-auto-revert-non-file-buffers t) ; Revert Dired and other buffers too
    (global-auto-revert-ignore-modes '(Buffer-menu-mode)))
#+end_src

** Recent Files

#+begin_src emacs-lisp
  (use-package recentf
    :straight nil
    :hook (after-init . recentf-mode)
    :custom
    (recentf-max-saved-items 300)          ; Default is only 20
    (recentf-max-menu-items 15)
    (recentf-auto-cleanup (if (daemonp) 300 'never))
    :config
    (setq recentf-exclude (list "^/\\(?:ssh\\|su\\|sudo\\)?:")))
#+end_src

** Save Place
Remember cursor position in files.

#+begin_src emacs-lisp
  (use-package saveplace
    :straight nil
    :hook (after-init . save-place-mode)
    :custom
    (save-place-limit 600)
    :config
    (setq save-place-file (expand-file-name "saveplace" user-emacs-directory)))
#+end_src

** Save History
Preserve minibuffer history between sessions.

#+begin_src emacs-lisp
  (use-package savehist
    :straight nil
    :hook (after-init . savehist-mode)
    :custom
    (history-length 300)
    (savehist-save-minibuffer-history t)
    :config
    (setq savehist-additional-variables
          '(kill-ring                      ; clipboard
            register-alist                 ; macros
            mark-ring global-mark-ring     ; marks
            search-ring regexp-search-ring))) ; searches
#+end_src

* Text Editing

** Indentation and Formatting

#+begin_src emacs-lisp
  ;; Indentation settings
  (setq-default indent-tabs-mode nil)      ; Use spaces instead of tabs
  (setq-default tab-width 4)               ; Set tab width to 4 spaces
  (setq-default tab-always-indent nil)     ; Enable TAB for both indent and completion
  
  ;; Line settings
  (setq-default fill-column 80)            ; Wrap at 80 columns
  (setq require-final-newline t)           ; Always end files with newline
  (setq sentence-end-double-space nil)     ; No double space after sentences
  (setq-default word-wrap t)               ; Wrap at word boundaries
  
  ;; Better line handling
  (setq-default truncate-lines t)          ; Disable line wrapping by default
  (setq truncate-partial-width-windows nil) ; Allow wrapping in split windows
#+end_src

** Undo Settings

#+begin_src emacs-lisp
  (use-package simple
    :straight nil
    :custom
    (undo-limit (* 13 160000))
    (undo-strong-limit (* 13 240000))
    (undo-outer-limit (* 13 24000000)))
#+end_src

** Scrolling

#+begin_src emacs-lisp
  ;; Smooth scrolling settings
  (setq scroll-conservatively 101)         ; Never recenter point
  (setq scroll-margin 0)                   ; No margin at top and bottom
  (setq scroll-preserve-screen-position t) ; Keep cursor position when scrolling
  (setq scroll-error-top-bottom t)         ; Move to buffer limits before signaling error
  (setq auto-window-vscroll nil)           ; Disable automatic vertical scroll adjustments
  
  ;; Horizontal scrolling
  (setq hscroll-margin 2)
  (setq hscroll-step 1)
#+end_src

* UI and Display

** Windows and Frames

#+begin_src emacs-lisp
  ;; Window splitting preference
  (setq split-width-threshold 170)         ; Prefer vertical splits
  (setq split-height-threshold nil)
  
  ;; Frame resizing
  (setq frame-resize-pixelwise t)          ; Resize frames pixel by pixel
  (setq window-resize-pixelwise nil)       ; But not windows
  
  ;; Window dividers
  (setq window-divider-default-bottom-width 1)
  (setq window-divider-default-right-width 1)
  (setq window-divider-default-places t)
  
  ;; Fringe settings
  (setq-default left-fringe-width 8)
  (setq-default right-fringe-width 8)
  (setq-default indicate-buffer-boundaries nil)
  (setq-default indicate-empty-lines nil)
#+end_src

** Buffer Management

#+begin_src emacs-lisp
  ;; Buffer naming
  (use-package uniquify
    :straight nil
    :custom
    (uniquify-buffer-name-style 'forward))
  
  ;; Skip confirmation for new files/buffers
  (setq confirm-nonexistent-file-or-buffer nil)
#+end_src

* Programming

** Show-Paren
Highlight matching parentheses.

#+begin_src emacs-lisp
  (use-package paren
    :straight nil
    :hook (after-init . show-paren-mode)
    :custom
    (show-paren-delay 0.1)
    (show-paren-highlight-openparen t)
    (show-paren-when-point-inside-paren t)
    (show-paren-when-point-in-periphery t))
#+end_src

** Compilation

#+begin_src emacs-lisp
  (use-package compile
    :straight nil
    :custom
    (compilation-always-kill t)            ; Always kill running compilation
    (compilation-ask-about-save nil)       ; Save without asking
    (compilation-scroll-output 'first-error) ; Scroll until first error
    (next-error-recenter '(4)))            ; Recenter when jumping to errors
#+end_src

** Eglot (LSP client)

#+begin_src emacs-lisp
  (use-package eglot
    :straight nil
    :custom
    (eglot-sync-connect 1)                 ; Shorter connect timeout
    (eglot-autoshutdown t)                 ; Auto shutdown when buffer closed
    (eglot-extend-to-xref t)               ; Enable in xref-referenced files
    (eglot-events-buffer-size 0)           ; Disable events buffer (performance)
    (eglot-report-progress nil))           ; Reduce minibuffer noise
#+end_src

** Flymake

+begin_src emacs-lisp
  (use-package flymake
    :straight nil
    :custom
    (flymake-fringe-indicator-position 'left-fringe)
    (flymake-show-diagnostics-at-end-of-line nil)
    (flymake-suppress-zero-counters t)     ; Hide error counts when zero
    (flymake-wrap-around nil))             ; Don't wrap when navigating errors
#+end_src

** Xref

#+begin_src emacs-lisp
  (use-package xref
    :straight nil
    :custom
    (xref-show-definitions-function 'xref-show-definitions-completing-read)
    (xref-show-xrefs-function 'xref-show-definitions-completing-read))
#+end_src

* File Modes

** Dired Improvements

#+begin_src emacs-lisp
  (use-package dired
    :straight nil
    :custom
    (dired-free-space nil)                 ; Don't show free space
    (dired-dwim-target t)                  ; Smart target for copy/move
    (dired-deletion-confirmer 'y-or-n-p)   ; Simpler confirmation
    (dired-filter-verbose nil)             ; Reduce noise
    (dired-recursive-deletes 'top)         ; Simplify recursive deletes
    (dired-recursive-copies 'always)       ; Always copy recursively
    (dired-create-destination-dirs 'ask)   ; Ask to create directories
    (dired-clean-confirm-killing-deleted-buffers nil) ; Don't confirm buffer kills
    (dired-vc-rename-file t)               ; Use VC for renames
    (image-dired-thumb-size 150)           ; Larger thumbnails
    
    ;; ls-lisp settings
    (ls-lisp-verbosity nil)
    (ls-lisp-dirs-first t)
    
    ;; Omit mode settings
    (dired-omit-verbose nil)
    :config
    (setq dired-omit-files (concat "\\`[.]\\'")))
#+end_src

** Ediff

#+begin_src emacs-lisp
  (use-package ediff
    :straight nil
    :custom
    (ediff-window-setup-function 'ediff-setup-windows-plain)
    (ediff-split-window-function 'split-window-horizontally))
#+end_src

* Miscellaneous

** Help System

#+begin_src emacs-lisp
  (use-package help
    :straight nil
    :custom
    (apropos-do-all t)                     ; More extensive search
    (help-enable-completion-autoload nil)  ; Don't autoload for completion
    (help-enable-autoload nil)
    (help-enable-symbol-autoload nil)
    (help-window-select t))                ; Focus help windows
#+end_src

** Spell Checking

#+begin_src emacs-lisp
  (use-package flyspell
    :straight nil
    :custom
    (flyspell-issue-welcome-flag nil)
    (flyspell-issue-message-flag nil))     ; Improves performance
  
  (use-package ispell
    :straight nil
    :custom
    (ispell-silently-savep t)
    (text-mode-ispell-word-completion nil)) ; For Emacs 30+
#+end_src

** Abbrev and Dabbrev

#+begin_src emacs-lisp
  (use-package abbrev
    :straight nil
    :custom
    (save-abbrevs 'silently)
    :config
    (setq abbrev-file-name (expand-file-name "abbrev_defs" user-emacs-directory)))
  
  (use-package dabbrev
    :straight nil
    :custom
    (dabbrev-upcase-means-case-search t)
    :config
    (setq dabbrev-ignored-buffer-modes
          '(archive-mode image-mode docview-mode tags-table-mode pdf-view-mode)))
#+end_src

** Disabled Commands

#+begin_src emacs-lisp
  ;; Enable useful commands that are disabled by default
  (dolist (cmd '(list-timers narrow-to-region upcase-region downcase-region
                           erase-buffer scroll-left dired-find-alternate-file))
    (put cmd 'disabled nil))
#+end_src

* Language-Specific Settings

** Python

#+begin_src emacs-lisp
  (use-package python
    :straight nil
    :custom
    (python-indent-guess-indent-offset-verbose nil)) ; Less verbose indentation
#+end_src

** Shell Script

#+begin_src emacs-lisp
  (use-package sh-script
    :straight nil
    :custom
    (sh-indent-after-continuation 'always))
#+end_src

* Final Configuration

#+begin_src emacs-lisp
  ;; You can add any personal configurations or overrides here
  
  ;; Provide the init feature
  (provide 'init)
#+end_src
